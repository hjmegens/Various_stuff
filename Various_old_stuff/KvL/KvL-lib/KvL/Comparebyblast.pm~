package Comparebyblast;
use strict;
use warnings;

sub get_old_and_new {
	my ($species, $mirna, $chromosome, $mirna_start, $mirna_end, $gene_transcript) = @_;
	
	my $slice_adaptor = Bio::EnsEMBL::Registry->get_adaptor($species,'core','Slice');
	my $gene_adaptor = Bio::EnsEMBL::Registry->get_adaptor($species,'core','Gene');
	my $transcript_adaptor = Bio::EnsEMBL::Registry->get_adaptor($species,'core','Transcript');
	
	open (TO_40, ">temp/to_40.txt");
	print TO_40 "$species\n$gene_transcript\n$chromosome\n$mirna_start\n$mirna_end";
	close (TO_40);

	system ('get_from_40.pl');
	#system ('./to_40/get_from_40.pl');

	open (SMALL, "temp/seq_small_from40.txt");
	my ($sequence_small) = (<SMALL>);
	close (SMALL);	
	open (LARGE, "temp/seq_large_from40.txt");
	my ($sequence_large) = (<LARGE>);
	close (LARGE);
	
	chomp $sequence_small;
	chomp $sequence_large;
	#print $sequence_small."\n";
	#print $sequence_large."\n";
	
	#print "$mirna\t$gene_transcript\t$sequence_small\n";
	
	my $refname = $gene_transcript."-".$mirna."-".$mirna_start."-".$mirna_end;
	open (MIRNA, ">temp/mirna_ref.txt");

	print MIRNA ">mirna_$refname\n".$sequence_large."\n";
	close (MIRNA);

	#print $gene_transcript."\n";
	
	my $transcript = $transcript_adaptor->fetch_by_stable_id($gene_transcript);
	if (($transcript)){
		my $strand = $transcript ->strand();
		#print $strand."\n";
		my $gene_start = $transcript ->start();
		my $gene_end = $transcript ->end();
		$chromosome = $transcript ->seq_region_name();

		#print "\nIN MAIN PROGRAM!\n$mirna_start : $mirna_end\t$gene_start : $gene_end\n";
		
		if ($strand == 1){
			my $slice = $slice_adaptor->fetch_by_region('chromosome', $chromosome, ($gene_end - 10000) , ($gene_end + 10000));
			my $sequence = $slice ->seq();
			open (OUT, ">temp/gene_ref.txt");
			print OUT ">gene_$refname\n".$sequence."\n";
			close (OUT);
		}
	
		if ($strand == -1){
			print "$chromosome\n";
			my $slice = $slice_adaptor->fetch_by_region('chromosome', $chromosome, ($gene_start - 10000) , ($gene_start + 10000));
			my $sequence = $slice ->seq();
			open (OUT, ">temp/gene_ref.txt");
			print OUT ">gene_$refname\n".$sequence."\n";
			close (OUT);
		}
		do_blast($refname);

		get_positions($gene_start, $gene_end, $strand);
	}
	else {
		print "Transcript ID $gene_transcript no longer in 43!\n";
	}
	#print "\n\n==========================\n\n";
	
	


}

sub get_positions {

	my ($gene_start, $gene_end, $strand) = @_;
	my $mirna_start = 0;
	my $mirna_end = 0;

	my $in = new Bio::SearchIO(-format => 'blast', 
	                           -file   => 'temp/mytest.out');
	while( my $result = $in->next_result ) {
		while( my $hit = $result->next_hit ) {
			while( my $hsp = $hit->next_hsp ) {
				if( $hsp->length('total') > 120 ) {
					if ( $hsp->percent_identity >= 98 ) {
						my $hit_name = $hit->name; 
						my $hsp_length = $hsp->length('total');
						my $percent_id = $hsp->percent_identity;
						my $start_hit = $hsp->start('hit');
						my $end_hit = $hsp->end('hit');
						my $start_query = $hsp->start('query');
						my $end_query = $hsp->end('query');
						my $strand_hit = $hsp->strand('hit');
						my $strand_query = $hsp->strand('query');
						
						#print "$hsp_length\t$percent_id\t$start_hit $end_hit\t$start_query $end_query\t$strand_hit $strand_query\n";
						
						if ($strand == 1){

							if ($start_query == 1) {
								$mirna_start = $gene_end - 10000 + $start_hit + 100;
								$mirna_end = $gene_end - 10000 + $end_hit - 100;
							}

							if ($start_query == -1) {
								$mirna_start = $gene_end - 10000 + $end_hit - 100;
								$mirna_end = $gene_end - 10000 + $start_hit + 100;
							}
						}

						if ($strand == -1){

							if ($start_query == 1) {
								$mirna_start = $gene_start - 10000 + $start_hit + 100;
								$mirna_end = $gene_start - 10000 + $end_hit - 100;
							}

							if ($start_query == -1) {
								$mirna_start = $gene_start - 10000 + $start_hit + 100;
								$mirna_end = $gene_start - 10000 + $end_hit - 100;
							}
						}
					}
				}
			}  
		}
	}
	return ($mirna_start,$mirna_end);
}

sub do_blast {
	my ($refname)=@_;

	#`formatdb -i gene_ref.txt -p F -o T`;

	#`blastall -p blastn -d gene_ref.txt -i mirna_ref.txt -o mytest.out`;

	`bl2seq -p blastn -F F -j temp/gene_ref.txt -i temp/mirna_ref.txt -o temp/mytest.out`
}
1;
